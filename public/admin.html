<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administration - Carte KML</title>
  <style>
    :root { --bg:#f5f5f5; --primary:#667eea; --secondary:#764ba2; --ok:#22c55e; --danger:#ef4444; --warning:#f59e0b; }
    * { box-sizing: border-box }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg)}
    
    .header{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);color:#fff;padding:20px;text-align:center}
    .header h1{margin:0;font-weight:600;font-size:24px}
    .header p{margin:8px 0 0;opacity:0.9;font-size:14px}
    
    .container{max-width:800px;margin:0 auto;padding:20px}
    .card{background:#fff;border-radius:12px;padding:24px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .card h2{margin:0 0 16px;color:#333;font-size:18px}
    
    .btn{padding:12px 24px;border:0;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-success{background:var(--ok);color:#fff}
    .btn-warning{background:var(--warning);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
    
    .upload-area{border:2px dashed #ddd;border-radius:8px;padding:40px;text-align:center;margin:16px 0;transition:all 0.2s}
    .upload-area:hover{border-color:var(--primary);background:#f8f9ff}
    .upload-area.dragover{border-color:var(--primary);background:#f0f4ff}
    
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:16px 0}
    .stat{background:#f8f9fa;padding:16px;border-radius:8px;text-align:center}
    .stat-value{font-size:24px;font-weight:600;color:var(--primary);margin:0}
    .stat-label{font-size:12px;color:#666;margin:4px 0 0}
    
    .log{background:#f8f9fa;border-radius:8px;padding:16px;margin:16px 0;max-height:200px;overflow-y:auto;font-family:monospace;font-size:12px}
    .log-entry{margin:4px 0;padding:4px 8px;border-radius:4px}
    .log-success{background:#d1fae5;color:#065f46}
    .log-error{background:#fee2e2;color:#991b1b}
    .log-info{background:#dbeafe;color:#1e40af}
    
    .status{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
    .status-online{background:#d1fae5;color:#065f46}
    .status-offline{background:#fee2e2;color:#991b1b}
    
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="header">
    <h1>üîß Administration - Carte KML</h1>
    <p>G√©rez votre carte en temps r√©el</p>
  </div>

  <div class="container">
    <!-- Statut de connexion -->
    <div class="card">
      <h2>üìä Statut du syst√®me</h2>
      <div style="display:flex;align-items:center;gap:16px">
        <span class="status status-online" id="connectionStatus">üü¢ Connect√©</span>
        <span id="lastUpdate">Derni√®re mise √† jour: Jamais</span>
        <button class="btn btn-primary" onclick="checkStatus()">üîÑ V√©rifier</button>
      </div>
    </div>

    <!-- Statistiques actuelles -->
    <div class="card">
      <h2>üìà Statistiques actuelles</h2>
      <div class="stats" id="currentStats">
        <div class="stat">
          <div class="stat-value" id="totalPoints">-</div>
          <div class="stat-label">Points totaux</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="lastModified">-</div>
          <div class="stat-label">Derni√®re modification</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="fileSize">-</div>
          <div class="stat-label">Taille du fichier</div>
        </div>
      </div>
    </div>

    <!-- Upload de nouveau fichier -->
    <div class="card">
      <h2>üìÅ Mettre √† jour le fichier KML</h2>
      <div class="upload-area" id="uploadArea">
        <div style="font-size:48px;margin-bottom:16px">üìÑ</div>
        <div style="font-size:16px;margin-bottom:8px">Glissez-d√©posez votre fichier KML ici</div>
        <div style="font-size:14px;color:#666;margin-bottom:16px">ou cliquez pour s√©lectionner</div>
        <input type="file" id="kmlFile" accept=".kml,.xml" style="display:none">
        <button class="btn btn-primary" onclick="document.getElementById('kmlFile').click()">Choisir un fichier</button>
      </div>
      
      <div style="margin-top:16px">
        <button class="btn btn-success" id="uploadBtn" onclick="uploadKml()" disabled>üöÄ Mettre √† jour</button>
        <button class="btn btn-warning" onclick="previewKml()" id="previewBtn" disabled>üëÅÔ∏è Pr√©visualiser</button>
        <button class="btn btn-danger" onclick="resetKml()">üîÑ R√©initialiser</button>
      </div>
    </div>

    <!-- Pr√©visualisation -->
    <div class="card hidden" id="previewCard">
      <h2>üëÅÔ∏è Pr√©visualisation</h2>
      <div id="previewContent"></div>
    </div>

    <!-- Logs -->
    <div class="card">
      <h2>üìù Journal des activit√©s</h2>
      <div class="log" id="logContainer">
        <div class="log-entry log-info">Syst√®me initialis√©</div>
      </div>
      <button class="btn btn-primary" onclick="clearLog()">üóëÔ∏è Effacer les logs</button>
    </div>
  </div>

  <script>
    let currentFile = null;
    let isConnected = true;

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      loadCurrentStats();
      startStatusCheck();
    });

    // Configuration des √©v√©nements
    function setupEventListeners() {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('kmlFile');

      // Drag & Drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

      // File input
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
    }

    // Gestion de la s√©lection de fichier
    function handleFileSelect(file) {
      if (!file.name.toLowerCase().endsWith('.kml') && !file.name.toLowerCase().endsWith('.xml')) {
        addLog('Erreur: Veuillez s√©lectionner un fichier KML ou XML', 'error');
        return;
      }

      currentFile = file;
      document.getElementById('uploadBtn').disabled = false;
      document.getElementById('previewBtn').disabled = false;
      addLog(`Fichier s√©lectionn√©: ${file.name} (${formatFileSize(file.size)})`, 'info');
    }

    // Upload du fichier KML
    async function uploadKml() {
      if (!currentFile) return;

      try {
        addLog('Traitement du fichier...', 'info');
        
        // Lire le contenu du fichier
        const fileContent = await readFileAsText(currentFile);
        
        // Traiter le fichier directement c√¥t√© client
        const points = (fileContent.match(/<Placemark>/g) || []).length;
        addLog(`‚úÖ Fichier trait√©! ${points} points trouv√©s`, 'success');
        
        // Mettre √† jour le fichier local
        await updateLocalKmlFile(fileContent, currentFile.name);
        
        // Ouvrir la carte mise √† jour
        setTimeout(() => {
          window.open('/', '_blank');
        }, 1000);
        
      } catch (error) {
        addLog(`‚ùå Erreur lors du traitement: ${error.message}`, 'error');
      }
    }

    // Lire le fichier comme texte
    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(e);
        reader.readAsText(file);
      });
    }

    // Mettre √† jour le fichier KML local
    async function updateLocalKmlFile(kmlContent, fileName) {
      try {
        // Stocker le contenu dans localStorage
        const kmlData = {
          fileName: fileName || 'members.kml',
          kmlText: kmlContent,
          points: (kmlContent.match(/<Placemark>/g) || []).length,
          timestamp: new Date().toISOString(),
          lastModified: new Date().toLocaleString('fr-FR')
        };
        
        localStorage.setItem('kmlData', JSON.stringify(kmlData));
        addLog('‚úÖ Fichier KML sauvegard√© localement', 'success');
        
        // Mettre √† jour les statistiques
        document.getElementById('totalPoints').textContent = kmlData.points;
        document.getElementById('lastModified').textContent = kmlData.lastModified;
        document.getElementById('fileSize').textContent = formatFileSize(kmlContent.length);
        
      } catch (error) {
        addLog(`‚ùå Erreur lors de la sauvegarde: ${error.message}`, 'error');
      }
    }

    // Pr√©visualisation du fichier
    function previewKml() {
      if (!currentFile) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const kmlText = e.target.result;
        const parser = new DOMParser();
        const xml = parser.parseFromString(kmlText, 'text/xml');
        const placemarks = xml.getElementsByTagName('Placemark');
        
        let preview = `<h3>üìä Aper√ßu du fichier</h3>`;
        preview += `<p><strong>Nom:</strong> ${currentFile.name}</p>`;
        preview += `<p><strong>Taille:</strong> ${formatFileSize(currentFile.size)}</p>`;
        preview += `<p><strong>Placemarks trouv√©s:</strong> ${placemarks.length}</p>`;
        
        if (placemarks.length > 0) {
          preview += `<h4>Premiers points:</h4><ul>`;
          for (let i = 0; i < Math.min(5, placemarks.length); i++) {
            const name = placemarks[i].getElementsByTagName('name')[0]?.textContent || 'Sans nom';
            preview += `<li>${name}</li>`;
          }
          if (placemarks.length > 5) {
            preview += `<li>... et ${placemarks.length - 5} autres</li>`;
          }
          preview += `</ul>`;
        }
        
        document.getElementById('previewContent').innerHTML = preview;
        document.getElementById('previewCard').classList.remove('hidden');
      };
      reader.readAsText(currentFile);
    }

    // Charger les statistiques actuelles
    async function loadCurrentStats() {
      try {
        const response = await fetch('/api/stats');
        if (response.ok) {
          const stats = await response.json();
          document.getElementById('totalPoints').textContent = stats.points || '0';
          document.getElementById('lastModified').textContent = stats.lastModified || 'Jamais';
          document.getElementById('fileSize').textContent = stats.fileSize || '0 KB';
          document.getElementById('lastUpdate').textContent = `Derni√®re mise √† jour: ${new Date().toLocaleString()}`;
        }
      } catch (error) {
        addLog(`Erreur lors du chargement des statistiques: ${error.message}`, 'error');
      }
    }

    // V√©rifier le statut
    async function checkStatus() {
      try {
        const response = await fetch('/api/status');
        if (response.ok) {
          isConnected = true;
          document.getElementById('connectionStatus').textContent = 'üü¢ Connect√©';
          document.getElementById('connectionStatus').className = 'status status-online';
          addLog('‚úÖ Connexion au serveur √©tablie', 'success');
        } else {
          throw new Error('Serveur non disponible');
        }
      } catch (error) {
        isConnected = false;
        document.getElementById('connectionStatus').textContent = 'üî¥ D√©connect√©';
        document.getElementById('connectionStatus').className = 'status status-offline';
        addLog(`‚ùå Erreur de connexion: ${error.message}`, 'error');
      }
    }

    // Notifier les clients
    async function notifyClients() {
      try {
        await fetch('/api/notify-update', { method: 'POST' });
        addLog('üì¢ Notification envoy√©e aux clients', 'info');
      } catch (error) {
        addLog(`Erreur lors de la notification: ${error.message}`, 'error');
      }
    }

    // R√©initialiser
    function resetKml() {
      if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser le fichier KML ?')) {
        currentFile = null;
        document.getElementById('kmlFile').value = '';
        document.getElementById('uploadBtn').disabled = true;
        document.getElementById('previewBtn').disabled = true;
        document.getElementById('previewCard').classList.add('hidden');
        addLog('üîÑ Fichier r√©initialis√©', 'info');
      }
    }

    // V√©rification p√©riodique du statut
    function startStatusCheck() {
      setInterval(checkStatus, 30000); // Toutes les 30 secondes
    }

    // Ajouter une entr√©e au log
    function addLog(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // Effacer les logs
    function clearLog() {
      document.getElementById('logContainer').innerHTML = '';
      addLog('Journal effac√©', 'info');
    }

    // Formater la taille de fichier
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  </script>
</body>
</html>
